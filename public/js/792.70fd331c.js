"use strict";(globalThis["webpackChunkmomentum_fw_dev"]=globalThis["webpackChunkmomentum_fw_dev"]||[]).push([[792],{2792:(e,t,s)=>{s.r(t),s.d(t,{default:()=>I});var a=s(1758),i=s(8790);const l={class:"flex-center column align-items-center"},r=(0,a.Lk)("p",null,"Loading Asset Packs...",-1),n={key:1},o={class:"q-mt-xs q-ml-md q-mr-sm flex flex-col items-center justify-between",style:{"flex-wrap":"nowrap"}},c={class:"text-left text-bold"},d={class:"text-h5"},g={class:"text-h7"},p={class:"q-mt-sm q-mx-md"},h={key:0,class:"text-h7 q-mt-sm q-mx-md"},u={style:{flex:"1","margin-left":"6px",display:"flex","flex-wrap":"wrap"}};function f(e,t,s,f,m,v){const k=(0,a.g2)("q-spinner"),w=(0,a.g2)("q-carousel-slide"),y=(0,a.g2)("q-carousel"),b=(0,a.g2)("q-btn"),$=(0,a.g2)("q-tooltip"),_=(0,a.g2)("q-icon"),x=(0,a.g2)("q-card-actions"),E=(0,a.g2)("q-card"),P=(0,a.g2)("q-list"),R=(0,a.g2)("q-page");return(0,a.uX)(),(0,a.Wv)(R,{class:"flex-center column full-width"},{default:(0,a.k6)((()=>[(0,a.Lk)("div",l,[null===e.packs?((0,a.uX)(),(0,a.CE)(a.FK,{key:0},[(0,a.bF)(k,{color:"primary",size:"3em",class:"q-mb-md"}),r],64)):e.packs.length<1?((0,a.uX)(),(0,a.CE)("h5",n,"Nothing to see here ðŸ¤”")):((0,a.uX)(),(0,a.Wv)(P,{key:2,class:"packs-grid"},{default:(0,a.k6)((()=>[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(e.packs,(s=>((0,a.uX)(),(0,a.Wv)(E,(0,a.v6)({key:s.id},s,{class:"flex justify-between",style:{"flex-direction":"column"},dark:""}),{default:(0,a.k6)((()=>[(0,a.bF)(y,{animated:"",modelValue:e.slides[s.id],"onUpdate:modelValue":t=>e.slides[s.id]=t,arrows:s.preview_urls.length>1,navigation:s.preview_urls.length>1,"transition-prev":"slide-right","transition-next":"slide-left",infinite:""},{default:(0,a.k6)((()=>[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(s.preview_urls,((e,t)=>((0,a.uX)(),(0,a.Wv)(w,{key:t,name:t+1,"img-src":e},null,8,["name","img-src"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue","arrows","navigation"]),(0,a.Lk)("div",o,[(0,a.Lk)("div",c,[(0,a.Lk)("div",d,(0,i.v_)(s.name),1),(0,a.Lk)("div",g,"by "+(0,i.v_)(s.author),1)]),s.source_url?((0,a.uX)(),(0,a.Wv)(b,{key:0,href:s.source_url,target:"_blank",icon:"open_in_new",class:"main-btn",style:{border:"none",padding:"0",margin:"0",width:"50px",height:"50px"},flat:""},null,8,["href"])):(0,a.Q3)("",!0)]),(0,a.Lk)("div",p,[s.stats.packs>1?((0,a.uX)(),(0,a.Wv)(_,{key:0,size:"1.5em",left:"",name:"category"},{default:(0,a.k6)((()=>[(0,a.bF)($,{style:{"font-size":"1.2em",padding:"0.1em 0.3em"}},{default:(0,a.k6)((()=>[(0,a.eW)(" Contains "+(0,i.v_)(s.stats.packs)+" Asset Packs ",1)])),_:2},1024)])),_:2},1024)):(0,a.Q3)("",!0),s.stats.anims>0?((0,a.uX)(),(0,a.Wv)(_,{key:1,size:"1.5em",left:"",name:"ondemand_video"},{default:(0,a.k6)((()=>[(0,a.bF)($,{style:{"font-size":"1.2em",padding:"0.1em 0.3em"}},{default:(0,a.k6)((()=>[(0,a.eW)((0,i.v_)(s.stats.anims)+" Animation"+(0,i.v_)(s.stats.anims>1?"s":""),1)])),_:2},1024)])),_:2},1024)):(0,a.Q3)("",!0),s.stats.passport.length>0?((0,a.uX)(),(0,a.Wv)(_,{key:2,size:"1.5em",left:"",name:"portrait"},{default:(0,a.k6)((()=>[(0,a.bF)($,{style:{"font-size":"1.2em",padding:"0.1em 0.3em"}},{default:(0,a.k6)((()=>[(0,a.eW)((0,i.v_)(s.stats.passport.includes("Background")?"Passport Background"+(s.stats.passport.length>1?` and ${s.stats.passport.slice(1).join(", ")} Mood${s.stats.passport.length>2?"s":""}`:""):"")+" "+(0,i.v_)(s.stats.passport.includes("Background")?"":`${s.stats.passport.join(", ")} Passport Mood${s.stats.passport.length>1?"s":""}`),1)])),_:2},1024)])),_:2},1024)):(0,a.Q3)("",!0),s.stats.icons>0?((0,a.uX)(),(0,a.Wv)(_,{key:3,size:"1.5em",left:"",name:"wallpaper"},{default:(0,a.k6)((()=>[(0,a.bF)($,{style:{"font-size":"1.2em",padding:"0.1em 0.3em"}},{default:(0,a.k6)((()=>[(0,a.eW)((0,i.v_)(s.stats.icons)+" Icon"+(0,i.v_)(s.stats.icons>1?"s":""),1)])),_:2},1024)])),_:2},1024)):(0,a.Q3)("",!0),s.stats.fonts.length>0?((0,a.uX)(),(0,a.Wv)(_,{key:4,size:"1.5em",left:"",name:"text_fields"},{default:(0,a.k6)((()=>[(0,a.bF)($,{style:{"font-size":"1.2em",padding:"0.1em 0.3em"}},{default:(0,a.k6)((()=>[(0,a.eW)((0,i.v_)(s.stats.fonts.join(", "))+" Font"+(0,i.v_)(s.stats.fonts.length>1?"s":""),1)])),_:2},1024)])),_:2},1024)):(0,a.Q3)("",!0)]),s.description?((0,a.uX)(),(0,a.CE)("div",h,(0,i.v_)(s.description),1)):(0,a.Q3)("",!0),(0,a.bF)(x,{align:"stretch"},{default:(0,a.k6)((()=>[(0,a.bF)(b,{href:`${s.zipFile.url}?sha256=${s.zipFile.sha256}`,class:"main-btn",style:{flex:"1",padding:"5px"},flat:""},{default:(0,a.k6)((()=>[(0,a.eW)("Download")])),_:2},1032,["href"]),(0,a.Lk)("div",u,[!1===e.flags.ableToExtract?((0,a.uX)(),(0,a.Wv)(b,{key:0,onClick:t[0]||(t[0]=t=>e.updateFw()),class:"main-btn",style:{flex:"1",padding:"5px"},flat:""},{default:(0,a.k6)((()=>[(0,a.eW)("Update FW")])),_:1})):e.queue.includes(s)?0===e.queue.indexOf(s)?((0,a.uX)(),(0,a.Wv)(b,{key:2,class:"main-btn",style:(0,i.Tr)(`flex: 1; padding: 5px; background-image: linear-gradient(to right, #a883e9 ${100*e.progress}%, transparent ${100*e.progress}%);`),disable:"",flat:""},{default:(0,a.k6)((()=>[(0,a.eW)((0,i.v_)(e.installStatus),1)])),_:1},8,["style"])):((0,a.uX)(),(0,a.Wv)(b,{key:3,class:"main-btn",style:{flex:"1",padding:"5px"},disable:"",flat:""},{default:(0,a.k6)((()=>[(0,a.eW)("Queued")])),_:1})):((0,a.uX)(),(0,a.Wv)(b,{key:1,disable:!e.serialSupported||e.rpcToggling||e.connected&&null===e.flags.ableToExtract,onClick:t=>e.enqueue(s,"install"),class:(0,i.C4)("main-btn "+(e.installed[s.id]&&e.installed[s.id].sha256!==s.tarFile.sha256?"attention":"")),style:{flex:"1",padding:"5px"},flat:""},{default:(0,a.k6)((()=>[(0,a.eW)((0,i.v_)(e.serialSupported?e.rpcToggling?"Connecting":e.connected?null===e.flags.ableToExtract?"Loading":e.installed[s.id]?e.installed[s.id].sha256===s.tarFile.sha256?"Reflash":"Update":"Install":"Connect":"Unsupported"),1)])),_:2},1032,["disable","onClick","class"])),e.installed[s.id]?((0,a.uX)(),(0,a.Wv)(b,{key:4,onClick:t=>e.enqueue(s,"remove"),class:"main-btn negative",style:{flex:"0",padding:"5px","margin-left":"6px",overflow:"visible"},disable:e.queue.includes(s),flat:"",icon:"delete_outline"},null,8,["onClick","disable"])):(0,a.Q3)("",!0)])])),_:2},1024)])),_:2},1040)))),128))])),_:1}))])])),_:1})}s(4748),s(5584);var m=s(7360),v=s(8734),k=s(2314),w=s(8736),y=s.n(w);const b="/ext/asset_packs",$="/ext/.tmp/mntm",_=`${b}/.manifests`,x=".pack",E=(0,a.pM)({name:"PagePacks",props:{flipper:Object,connected:Boolean,rpcActive:Boolean,rpcToggling:Boolean,serialSupported:Boolean,info:Object},setup(){return{packs:(0,v.KR)(null),installed:(0,v.KR)({}),slides:(0,v.KR)({}),flags:(0,v.KR)({restarting:!1,rpcActive:!1,rpcToggling:!1,ableToExtract:null}),progress:(0,v.KR)(0),installStatus:(0,v.KR)(null),queue:(0,v.KR)([]),queueActions:(0,v.KR)([]),fakeExtractProgress:(0,v.KR)(null)}},watch:{async info(e,t){null!==e&&e.storage_databases_present&&this.connected&&await this.start()}},methods:{async updateFw(){window.top.location.href="/update"},async enqueue(e,t){if(this.serialSupported)if(this.connected&&null!=this.info&&this.rpcActive){if(this.queue.push(e),this.queueActions.push(t),!(this.queue.length>1))while(this.queue.length>0)try{const s=3;let a=-1;const i=e=>{this.progress=e/s+1/s*a};this.progress=0,this.installStatus="Loading",a++,e=this.queue[0],t=this.queueActions[0];const l=`${_}/${e.id}${x}`,r=async()=>{const t=this.installed[e.id];if(t){for(const e of t.folders){const t=`${b}/${e}`;await this.flipper.commands.storage.remove(t,!0).catch((e=>this.rpcErrorHandler(e,"storage.remove"))).finally((()=>{this.$emit("log",{level:"debug",message:`Packs: storage.remove: ${t}`})}))}await this.flipper.commands.storage.remove(l,!1).catch((e=>this.rpcErrorHandler(e,"storage.remove"))).finally((()=>{this.$emit("log",{level:"debug",message:`Packs: storage.remove: ${l}`})}))}};if("remove"===t){this.installStatus="Deleting",await r(),delete this.installed[e.id];continue}if("install"!==t)continue;let n=null;const o=e.tarFile,c=`${o.url}?sha256=${o.sha256}`,d=await fetch(c).then((async e=>{if(e.status>=400)throw new Error("Pack returned "+e.status);n=r();const t=Number(e.headers.get("content-length")),s=e.body.getReader();let a=0;const l=[];while(1){const{done:e,value:r}=await s.read();if(e)break;l.push(r),a+=r.length,i(a/t)}const o=new Uint8Array(a);let c=0;for(const i of l)o.set(i,c),c+=i.length;return o})).catch((e=>{throw this.$emit("showNotif",{message:"Failed to fetch pack: "+e.toString(),color:"negative"}),this.$emit("log",{level:"error",message:"Packs: Failed to fetch pack: "+e.toString()}),e})).finally((()=>{this.$emit("log",{level:"debug",message:"Packs: Downloaded pack from "+c})}));this.installStatus="Cleanup",await n;const g=async e=>{e.endsWith("/")&&(e=e.slice(0,-1));let t="";for(const s of e.split("/"))"/"!==t&&(t+="/"),t+=s,t.length<6||await this.flipper.commands.storage.mkdir(t).catch((e=>this.rpcErrorHandler(e,"storage.mkdir"))).finally((()=>{this.$emit("log",{level:"debug",message:"Packs: storage.mkdir: "+t})}))};await g(_),await g($);const p=`${$}/${e.id}.tar.gz`;this.installStatus="Copying",a++;const h=this.flipper.emitter.on("storageWriteRequest/progress",(e=>{i(e.progress/e.total)}));let u=performance.now(),f=0;await this.flipper.commands.storage.write(p,d).catch((e=>{throw this.rpcErrorHandler(e,"storage.write"),e})).finally((()=>{f=performance.now()-u,this.$emit("log",{level:"debug",message:`Packs: storage.write: ${p} took ${Math.round(f)}ms`})})),h(),this.installStatus="Extract",a++,u=performance.now();const m=10*f;this.fakeExtractProgress=setInterval((()=>{i((performance.now()-u)/m)}),250),await this.flipper.commands.storage.tarExtract(p,b).catch((e=>{throw this.rpcErrorHandler(e,"storage.tarExtract"),e})).finally((()=>{null!==this.fakeExtractProgress&&(clearInterval(this.fakeExtractProgress),this.fakeExtractProgress=null),f=performance.now()-u,this.$emit("log",{level:"debug",message:`Packs: storage.tarExtract: ${p} to ${b} took ${Math.round(f)}ms`})})),i(1),this.installStatus="Cleanup",await this.flipper.commands.storage.remove(p,!1).catch((e=>this.rpcErrorHandler(e,"storage.remove"))).finally((()=>{this.$emit("log",{level:"debug",message:"Packs: storage.remove: "+p})}));const v={sha256:o.sha256,folders:e.stats.folders},k=(new TextEncoder).encode(JSON.stringify(v));await this.flipper.commands.storage.write(l,k).catch((e=>{throw this.rpcErrorHandler(e,"storage.write"),e})).finally((()=>{this.$emit("log",{level:"debug",message:`Packs: storage.write: ${l}`})})),this.installed[e.id]=v}finally{this.queue.shift(),this.queueActions.shift(),this.installStatus=null,this.progress=0}}else this.rpcToggling||this.$emit("selectPort")},async loadPackManifest(e){try{const t=await this.flipper.commands.storage.read(e).catch((e=>{throw this.rpcErrorHandler(e,"storage.read"),e})).finally((()=>{this.$emit("log",{level:"debug",message:`Packs: storage.read: ${e}`})})),s=(new TextDecoder).decode(t),a=JSON.parse(s);return a.sha256&&Array.isArray(a.folders)?{sha256:a.sha256,folders:a.folders}:null}catch(t){return console.log(t),null}},async loadInstalledPacks(){const e={};try{const t=await this.flipper.commands.storage.list(_).catch((e=>{if("ERROR_STORAGE_NOT_EXIST"===e)return[];throw this.rpcErrorHandler(e,"storage.list"),e})).finally((()=>{this.$emit("log",{level:"debug",message:`Packs: storage.list: ${_}`})}));for(const s of t){if(1===s.type||!s.size)continue;if(!s.name.endsWith(x))continue;const t=s.name.slice(0,-x.length);for(const a of this.packs)if(a.id===t){const a=await this.loadPackManifest(`${_}/${s.name}`);a&&(e[t]=a);break}}}catch(t){console.log(t)}console.log(e),this.installed=e},async startRpc(){this.flags.rpcToggling=!0;const e=await this.flipper.commands.startRpcSession(this.flipper);if(!e.resolved||e.error)throw this.$emit("showNotif",{message:"Unable to start RPC session. Reload the page or reconnect Flipper manually.",color:"negative",reloadBtn:!0}),this.$emit("log",{level:"error",message:"Device: Couldn't start rpc session"}),new Error("Couldn't start rpc session");this.flags.rpcActive=!0,this.flags.rpcToggling=!1,this.$emit("setRpcStatus",!0),this.$emit("log",{level:"info",message:"Device: RPC started"})},async stopRpc(){this.flags.rpcToggling=!0,await this.flipper.commands.stopRpcSession(),this.flags.rpcActive=!1,this.flags.rpcToggling=!1,this.$emit("setRpcStatus",!1),this.$emit("log",{level:"info",message:"Device: RPC stopped"})},async restartRpc(e){(this.connected&&this.flags.rpcActive&&!this.flags.restarting||e)&&(this.flags.restarting=!0,await this.flipper.closeReader(),await(0,k.A)(300),await this.flipper.disconnect(),await(0,k.A)(300),await this.flipper.connect(),await this.startRpc(),this.$emit("log",{level:"info",message:"Device: Restarted RPC"}))},passNotif(e){this.$emit("showNotif",e)},passLog(e){this.$emit("log",e)},rpcErrorHandler(e,t){e=e.toString(),this.$emit("showNotif",{message:`RPC error in command '${t}': ${e}`,color:"negative"}),this.$emit("log",{level:"error",message:`Device: RPC error in command '${t}': ${e}`})},async start(){this.serialSupported&&(this.flags.rpcActive=this.rpcActive,await this.loadInstalledPacks(),this.flags.ableToExtract=!y().lt(this.info.protobuf_version_major+"."+this.info.protobuf_version_minor+".0","0.23.0"),this.rpcActive||(setTimeout((()=>{if(!this.rpcActive)return this.restartRpc(!0)}),1e3),await this.startRpc()))}},async mounted(){const e=await(0,m.vy)().catch((e=>{throw this.$emit("showNotif",{message:"Unable to load asset packs from the server. Reload the page and try again.",color:"negative",reloadBtn:!0}),this.$emit("log",{level:"error",message:"Packs: Failed to fetch pack list"}),e}));for(const t of e)this.slides[t.id]=1;this.packs=e,this.connected&&null!==this.info&&this.info.storage_databases_present&&await this.start(),navigator.serial.addEventListener("disconnect",(e=>{null!==this.fakeExtractProgress&&(clearInterval(this.fakeExtractProgress),this.fakeExtractProgress=null),this.flags.ableToExtract=null,this.flags.rpcActive=!1,this.flags.rpcToggling=!1,this.installed={},this.$emit("setRpcStatus",!1)}))},async beforeUnmount(){}});var P=s(2807),R=s(7716),A=s(564),q=s(3999),C=s(3316),W=s(3454),S=s(8951),T=s(1693),F=s(492),X=s(7410),Q=s(2669),z=s(8582),L=s.n(z);const K=(0,P.A)(E,[["render",f]]),I=K;L()(E,"components",{QPage:R.A,QSpinner:A.A,QList:q.A,QCard:C.A,QCarousel:W.A,QCarouselSlide:S.A,QBtn:T.A,QIcon:F.A,QTooltip:X.A,QCardActions:Q.A})}}]);