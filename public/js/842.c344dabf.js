"use strict";(globalThis["webpackChunkmomentum_fw_dev"]=globalThis["webpackChunkmomentum_fw_dev"]||[]).push([[842],{6842:(e,t,s)=>{s.r(t),s.d(t,{default:()=>j});var a=s(1758),i=s(8790);const l={class:"flex-center column align-items-center"},r=(0,a.Lk)("p",null,"Loading Asset Packs...",-1),o={key:1},n={key:2,class:"flex column nowrap"},c={class:"flex justify-center q-gutter-sm"},d={class:"q-mt-xs q-ml-md q-mr-sm flex items-center justify-between",style:{"flex-wrap":"nowrap"}},p={class:"text-left text-bold col-grow"},g={class:"text-h5 flex justify-between"},h={class:"text-h7 q-mr-sm flex justify-between"},u={key:0,class:"q-mt-xs q-mx-md"},m={class:"text-grey text-caption q-mx-md flex justify-between"},f={style:{flex:"1","margin-left":"6px",display:"flex","flex-wrap":"wrap"}};function k(e,t,s,k,v,w){const y=(0,a.g2)("q-spinner"),b=(0,a.g2)("q-icon"),x=(0,a.g2)("q-input"),_=(0,a.g2)("q-select"),$=(0,a.g2)("q-carousel-slide"),P=(0,a.g2)("q-carousel"),E=(0,a.g2)("q-btn"),A=(0,a.g2)("q-tooltip"),R=(0,a.g2)("q-card-actions"),q=(0,a.g2)("q-card"),C=(0,a.g2)("q-list"),S=(0,a.g2)("q-page");return(0,a.uX)(),(0,a.Wv)(S,{class:"flex-center column full-width"},{default:(0,a.k6)((()=>[(0,a.Lk)("div",l,[null===e.packs?((0,a.uX)(),(0,a.CE)(a.FK,{key:0},[(0,a.bF)(y,{color:"primary",size:"3em",class:"q-mb-md"}),r],64)):e.packs.length<1?((0,a.uX)(),(0,a.CE)("h5",o,"Nothing to see here ðŸ¤”")):((0,a.uX)(),(0,a.CE)("div",n,[(0,a.Lk)("div",c,[(0,a.bF)(x,{"bottom-slots":"",modelValue:e.search,"onUpdate:modelValue":t[1]||(t[1]=t=>e.search=t),placeholder:"Search",dense:"",dark:"",borderless:"",style:{width:"200px"}},{prepend:(0,a.k6)((()=>[(0,a.bF)(b,{name:"search"})])),append:(0,a.k6)((()=>[""!==e.search?((0,a.uX)(),(0,a.Wv)(b,{key:0,name:"close",onClick:t[0]||(t[0]=t=>e.search=""),class:"cursor-pointer"})):(0,a.Q3)("",!0)])),_:1},8,["modelValue"]),(0,a.bF)(_,{modelValue:e.sorting,"onUpdate:modelValue":t[2]||(t[2]=t=>e.sorting=t),options:e.sortOptions,style:{width:"142px","border-radius":"14px","border-width":"2px"},"popup-content-style":"width: 142px; height: auto; max-height: 320px; border-radius: 14px; border: 2px solid white;","popup-content-class":"bg-black text-gray-3","options-selected-class":"bg-black text-white",behavior:"menu","options-dense":"",borderless:"",dense:"",dark:""},null,8,["modelValue","options"])]),(0,a.bF)(C,{class:"packs-grid grow"},{default:(0,a.k6)((()=>[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(e.packsModel,(s=>((0,a.uX)(),(0,a.Wv)(q,(0,a.v6)({key:s.id},s,{class:"flex justify-between",style:{"flex-direction":"column"},dark:""}),{default:(0,a.k6)((()=>[(0,a.bF)(P,{animated:"",modelValue:e.slides[s.id],"onUpdate:modelValue":t=>e.slides[s.id]=t,arrows:s.preview_urls.length>1,navigation:s.preview_urls.length>1,"transition-prev":"slide-right","transition-next":"slide-left",infinite:""},{default:(0,a.k6)((()=>[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(s.preview_urls,((e,t)=>((0,a.uX)(),(0,a.Wv)($,{key:t,name:t+1,"img-src":e},null,8,["name","img-src"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue","arrows","navigation"]),(0,a.Lk)("div",d,[(0,a.Lk)("div",p,[(0,a.Lk)("div",g,[(0,a.eW)((0,i.v_)(s.name)+" ",1),s.source_url?((0,a.uX)(),(0,a.Wv)(E,{key:0,href:s.source_url,target:"_blank",icon:"open_in_new",class:"flat-btn",style:{padding:"0","margin-right":"5px"},flat:""},null,8,["href"])):(0,a.Q3)("",!0)]),(0,a.Lk)("div",h,[(0,a.eW)(" by "+(0,i.v_)(s.author)+" ",1),(0,a.Lk)("span",null,[s.stats.packs>1?((0,a.uX)(),(0,a.Wv)(b,{key:0,size:"1.3em",style:{"margin-left":"5px"},name:"category"},{default:(0,a.k6)((()=>[(0,a.bF)(A,{style:{"font-size":"1.2em",padding:"0.1em 0.3em"}},{default:(0,a.k6)((()=>[(0,a.eW)(" Contains "+(0,i.v_)(s.stats.packs)+" Asset Packs ",1)])),_:2},1024)])),_:2},1024)):(0,a.Q3)("",!0),s.stats.anims>0?((0,a.uX)(),(0,a.Wv)(b,{key:1,size:"1.3em",style:{"margin-left":"5px"},name:"ondemand_video"},{default:(0,a.k6)((()=>[(0,a.bF)(A,{style:{"font-size":"1.2em",padding:"0.1em 0.3em"}},{default:(0,a.k6)((()=>[(0,a.eW)((0,i.v_)(s.stats.anims)+" Animation"+(0,i.v_)(s.stats.anims>1?"s":""),1)])),_:2},1024)])),_:2},1024)):(0,a.Q3)("",!0),s.stats.passport.length>0?((0,a.uX)(),(0,a.Wv)(b,{key:2,size:"1.3em",style:{"margin-left":"5px"},name:"portrait"},{default:(0,a.k6)((()=>[(0,a.bF)(A,{style:{"font-size":"1.2em",padding:"0.1em 0.3em"}},{default:(0,a.k6)((()=>[(0,a.eW)((0,i.v_)(s.stats.passport.includes("Background")?"Passport Background"+(s.stats.passport.length>1?` and ${s.stats.passport.slice(1).join(", ")} Mood${s.stats.passport.length>2?"s":""}`:""):"")+" "+(0,i.v_)(s.stats.passport.includes("Background")?"":`${s.stats.passport.join(", ")} Passport Mood${s.stats.passport.length>1?"s":""}`),1)])),_:2},1024)])),_:2},1024)):(0,a.Q3)("",!0),s.stats.icons>0?((0,a.uX)(),(0,a.Wv)(b,{key:3,size:"1.3em",style:{"margin-left":"5px"},name:"wallpaper"},{default:(0,a.k6)((()=>[(0,a.bF)(A,{style:{"font-size":"1.2em",padding:"0.1em 0.3em"}},{default:(0,a.k6)((()=>[(0,a.eW)((0,i.v_)(s.stats.icons)+" Icon"+(0,i.v_)(s.stats.icons>1?"s":""),1)])),_:2},1024)])),_:2},1024)):(0,a.Q3)("",!0),s.stats.fonts.length>0?((0,a.uX)(),(0,a.Wv)(b,{key:4,size:"1.3em",style:{"margin-left":"5px"},name:"text_fields"},{default:(0,a.k6)((()=>[(0,a.bF)(A,{style:{"font-size":"1.2em",padding:"0.1em 0.3em"}},{default:(0,a.k6)((()=>[(0,a.eW)((0,i.v_)(s.stats.fonts.join(", "))+" Font"+(0,i.v_)(s.stats.fonts.length>1?"s":""),1)])),_:2},1024)])),_:2},1024)):(0,a.Q3)("",!0)])])])]),s.description?((0,a.uX)(),(0,a.CE)("div",u,(0,i.v_)(s.description),1)):(0,a.Q3)("",!0),(0,a.Lk)("div",m,[(0,a.Lk)("span",null,"Last Updated: "+(0,i.v_)(s.stats.updated.toISOString().split("T")[0]),1)]),(0,a.bF)(R,{align:"stretch"},{default:(0,a.k6)((()=>[(0,a.bF)(E,{href:`${s.zipFile.url}?sha256=${s.zipFile.sha256}`,class:"main-btn",style:{flex:"1",padding:"5px"},flat:""},{default:(0,a.k6)((()=>[(0,a.eW)("Download")])),_:2},1032,["href"]),(0,a.Lk)("div",f,[!1===e.flags.ableToExtract?((0,a.uX)(),(0,a.Wv)(E,{key:0,onClick:t[3]||(t[3]=t=>e.updateFw()),class:"main-btn",style:{flex:"1",padding:"5px"},flat:""},{default:(0,a.k6)((()=>[(0,a.eW)("Update FW")])),_:1})):e.queue.includes(s)?0===e.queue.indexOf(s)?((0,a.uX)(),(0,a.Wv)(E,{key:2,class:"main-btn",style:(0,i.Tr)(`flex: 1; padding: 5px; background-image: linear-gradient(to right, #a883e9 ${100*e.progress}%, transparent ${100*e.progress}%);`),disable:"",flat:""},{default:(0,a.k6)((()=>[(0,a.eW)((0,i.v_)(e.installStatus),1)])),_:1},8,["style"])):((0,a.uX)(),(0,a.Wv)(E,{key:3,class:"main-btn",style:{flex:"1",padding:"5px"},disable:"",flat:""},{default:(0,a.k6)((()=>[(0,a.eW)("Queued")])),_:1})):((0,a.uX)(),(0,a.Wv)(E,{key:1,disable:!e.serialSupported||e.rpcToggling||e.connected&&null===e.flags.ableToExtract,onClick:t=>e.enqueue(s,"install"),class:(0,i.C4)("main-btn "+(e.installed[s.id]&&e.installed[s.id].sha256!==s.tarFile.sha256?"attention":"")),style:{flex:"1",padding:"5px"},flat:""},{default:(0,a.k6)((()=>[(0,a.eW)((0,i.v_)(e.serialSupported?e.rpcToggling?"Connecting":e.connected?null===e.flags.ableToExtract?"Loading":e.installed[s.id]?e.installed[s.id].sha256===s.tarFile.sha256?"Reflash":"Update":"Install":"Connect":"Unsupported"),1)])),_:2},1032,["disable","onClick","class"])),e.installed[s.id]?((0,a.uX)(),(0,a.Wv)(E,{key:4,onClick:t=>e.enqueue(s,"remove"),class:"main-btn negative",style:{flex:"0",padding:"5px","margin-left":"6px",overflow:"visible"},disable:e.queue.includes(s),flat:"",icon:"delete_outline"},null,8,["onClick","disable"])):(0,a.Q3)("",!0)])])),_:2},1024)])),_:2},1040)))),128))])),_:1})]))])])),_:1})}s(4748),s(5584);var v=s(7360),w=s(8734),y=s(2314),b=s(8736),x=s.n(b);const _="/ext/asset_packs",$="/ext/.tmp/mntm",P=`${_}/.manifests`,E=".pack",A=(0,a.pM)({name:"PagePacks",props:{flipper:Object,connected:Boolean,rpcActive:Boolean,rpcToggling:Boolean,serialSupported:Boolean,info:Object},computed:{packsModel(){if(!this.packs)return[];const e=this.packs;let t=null;switch(this.sorting){case"Alphabetic":t=(e,t)=>e.name.toLowerCase()>t.name.toLowerCase()?1:-1;break;case"New Updates":t=(e,t)=>e.stats.updated<t.stats.updated?1:-1;break;case"Old Updates":t=(e,t)=>e.stats.updated>t.stats.updated?1:-1;break;case"New Packs":t=(e,t)=>e.stats.added<t.stats.added?1:-1;break;case"Old Packs":t=(e,t)=>e.stats.added>t.stats.added?1:-1;break}return e.sort(t).filter((e=>{for(const t of[e.name,e.author,e.description])if(t.toLowerCase().includes(this.search.toLowerCase()))return!0;return!1}))}},setup(){return{packs:(0,w.KR)(null),installed:(0,w.KR)({}),slides:(0,w.KR)({}),search:(0,w.KR)(""),sorting:(0,w.KR)("New Updates"),sortOptions:(0,w.KR)(["Alphabetic","New Updates","New Packs","Old Updates","Old Packs"]),flags:(0,w.KR)({restarting:!1,rpcActive:!1,rpcToggling:!1,ableToExtract:null}),progress:(0,w.KR)(0),installStatus:(0,w.KR)(null),queue:(0,w.KR)([]),queueActions:(0,w.KR)([]),fakeExtractProgress:(0,w.KR)(null)}},watch:{async info(e,t){null!==e&&e.storage_databases_present&&this.connected&&await this.start()}},methods:{async updateFw(){window.top.location.href="/update"},async enqueue(e,t){if(this.serialSupported)if(this.connected&&null!=this.info&&this.rpcActive){if(this.queue.push(e),this.queueActions.push(t),!(this.queue.length>1))while(this.queue.length>0)try{const s=3;let a=-1;const i=e=>{this.progress=e/s+1/s*a};this.progress=0,this.installStatus="Loading",a++,e=this.queue[0],t=this.queueActions[0];const l=`${P}/${e.id}${E}`,r=async()=>{const t=this.installed[e.id];if(t){for(const e of t.folders){const t=`${_}/${e}`;await this.flipper.commands.storage.remove(t,!0).catch((e=>this.rpcErrorHandler(e,"storage.remove"))).finally((()=>{this.$emit("log",{level:"debug",message:`Packs: storage.remove: ${t}`})}))}await this.flipper.commands.storage.remove(l,!1).catch((e=>this.rpcErrorHandler(e,"storage.remove"))).finally((()=>{this.$emit("log",{level:"debug",message:`Packs: storage.remove: ${l}`})}))}};if("remove"===t){this.installStatus="Deleting",await r(),delete this.installed[e.id];continue}if("install"!==t)continue;let o=null;const n=e.tarFile,c=`${n.url}?sha256=${n.sha256}`,d=await fetch(c).then((async e=>{if(e.status>=400)throw new Error("Pack returned "+e.status);o=r();const t=Number(e.headers.get("content-length")),s=e.body.getReader();let a=0;const l=[];while(1){const{done:e,value:r}=await s.read();if(e)break;l.push(r),a+=r.length,i(a/t)}const n=new Uint8Array(a);let c=0;for(const i of l)n.set(i,c),c+=i.length;return n})).catch((e=>{throw this.$emit("showNotif",{message:"Failed to fetch pack: "+e.toString(),color:"negative"}),this.$emit("log",{level:"error",message:"Packs: Failed to fetch pack: "+e.toString()}),e})).finally((()=>{this.$emit("log",{level:"debug",message:"Packs: Downloaded pack from "+c})}));this.installStatus="Cleanup",await o;const p=async e=>{e.endsWith("/")&&(e=e.slice(0,-1));let t="";for(const s of e.split("/"))"/"!==t&&(t+="/"),t+=s,t.length<6||await this.flipper.commands.storage.mkdir(t).catch((e=>this.rpcErrorHandler(e,"storage.mkdir"))).finally((()=>{this.$emit("log",{level:"debug",message:"Packs: storage.mkdir: "+t})}))};await p(P),await p($);const g=`${$}/${e.id}.tar.gz`;this.installStatus="Copying",a++;const h=this.flipper.emitter.on("storageWriteRequest/progress",(e=>{i(e.progress/e.total)}));let u=performance.now(),m=0;await this.flipper.commands.storage.write(g,d).catch((e=>{throw this.rpcErrorHandler(e,"storage.write"),e})).finally((()=>{m=performance.now()-u,this.$emit("log",{level:"debug",message:`Packs: storage.write: ${g} took ${Math.round(m)}ms`})})),h(),this.installStatus="Extract",a++,u=performance.now();const f=10*m;this.fakeExtractProgress=setInterval((()=>{i((performance.now()-u)/f)}),250),await this.flipper.commands.storage.tarExtract(g,_).catch((e=>{throw this.rpcErrorHandler(e,"storage.tarExtract"),e})).finally((()=>{null!==this.fakeExtractProgress&&(clearInterval(this.fakeExtractProgress),this.fakeExtractProgress=null),m=performance.now()-u,this.$emit("log",{level:"debug",message:`Packs: storage.tarExtract: ${g} to ${_} took ${Math.round(m)}ms`})})),i(1),this.installStatus="Cleanup",await this.flipper.commands.storage.remove(g,!1).catch((e=>this.rpcErrorHandler(e,"storage.remove"))).finally((()=>{this.$emit("log",{level:"debug",message:"Packs: storage.remove: "+g})}));const k={sha256:n.sha256,folders:e.stats.folders},v=(new TextEncoder).encode(JSON.stringify(k));await this.flipper.commands.storage.write(l,v).catch((e=>{throw this.rpcErrorHandler(e,"storage.write"),e})).finally((()=>{this.$emit("log",{level:"debug",message:`Packs: storage.write: ${l}`})})),this.installed[e.id]=k}finally{this.queue.shift(),this.queueActions.shift(),this.installStatus=null,this.progress=0}}else this.rpcToggling||this.$emit("selectPort")},async loadPackManifest(e){try{const t=await this.flipper.commands.storage.read(e).catch((e=>{throw this.rpcErrorHandler(e,"storage.read"),e})).finally((()=>{this.$emit("log",{level:"debug",message:`Packs: storage.read: ${e}`})})),s=(new TextDecoder).decode(t),a=JSON.parse(s);return a.sha256&&Array.isArray(a.folders)?{sha256:a.sha256,folders:a.folders}:null}catch(t){return console.log(t),null}},async loadInstalledPacks(){const e={};try{const t=await this.flipper.commands.storage.list(P).catch((e=>{if("ERROR_STORAGE_NOT_EXIST"===e)return[];throw this.rpcErrorHandler(e,"storage.list"),e})).finally((()=>{this.$emit("log",{level:"debug",message:`Packs: storage.list: ${P}`})}));for(const s of t){if(1===s.type||!s.size)continue;if(!s.name.endsWith(E))continue;const t=s.name.slice(0,-E.length);for(const a of this.packs)if(a.id===t){const a=await this.loadPackManifest(`${P}/${s.name}`);a&&(e[t]=a);break}}}catch(t){console.log(t)}console.log(e),this.installed=e},async startRpc(){this.flags.rpcToggling=!0;const e=await this.flipper.commands.startRpcSession(this.flipper);if(!e.resolved||e.error)throw this.$emit("showNotif",{message:"Unable to start RPC session. Reload the page or reconnect Flipper manually.",color:"negative",reloadBtn:!0}),this.$emit("log",{level:"error",message:"Device: Couldn't start rpc session"}),new Error("Couldn't start rpc session");this.flags.rpcActive=!0,this.flags.rpcToggling=!1,this.$emit("setRpcStatus",!0),this.$emit("log",{level:"info",message:"Device: RPC started"})},async stopRpc(){this.flags.rpcToggling=!0,await this.flipper.commands.stopRpcSession(),this.flags.rpcActive=!1,this.flags.rpcToggling=!1,this.$emit("setRpcStatus",!1),this.$emit("log",{level:"info",message:"Device: RPC stopped"})},async restartRpc(e){(this.connected&&this.flags.rpcActive&&!this.flags.restarting||e)&&(this.flags.restarting=!0,await this.flipper.closeReader(),await(0,y.A)(300),await this.flipper.disconnect(),await(0,y.A)(300),await this.flipper.connect(),await this.startRpc(),this.$emit("log",{level:"info",message:"Device: Restarted RPC"}))},passNotif(e){this.$emit("showNotif",e)},passLog(e){this.$emit("log",e)},rpcErrorHandler(e,t){e=e.toString(),this.$emit("showNotif",{message:`RPC error in command '${t}': ${e}`,color:"negative"}),this.$emit("log",{level:"error",message:`Device: RPC error in command '${t}': ${e}`})},async start(){this.serialSupported&&(this.flags.rpcActive=this.rpcActive,await this.loadInstalledPacks(),this.flags.ableToExtract=!x().lt(this.info.protobuf_version_major+"."+this.info.protobuf_version_minor+".0","0.23.0"),this.rpcActive||(setTimeout((()=>{if(!this.rpcActive)return this.restartRpc(!0)}),1e3),await this.startRpc()))}},async mounted(){const e=await(0,v.vy)().catch((e=>{throw this.$emit("showNotif",{message:"Unable to load asset packs from the server. Reload the page and try again.",color:"negative",reloadBtn:!0}),this.$emit("log",{level:"error",message:"Packs: Failed to fetch pack list"}),e}));for(const t of e)this.slides[t.id]=1;this.packs=e,this.connected&&null!==this.info&&this.info.storage_databases_present&&await this.start(),navigator.serial.addEventListener("disconnect",(e=>{null!==this.fakeExtractProgress&&(clearInterval(this.fakeExtractProgress),this.fakeExtractProgress=null),this.flags.ableToExtract=null,this.flags.rpcActive=!1,this.flags.rpcToggling=!1,this.installed={},this.$emit("setRpcStatus",!1)}))},async beforeUnmount(){}});var R=s(2807),q=s(7716),C=s(564),S=s(9270),W=s(492),F=s(2711),T=s(3999),L=s(3316),Q=s(3454),X=s(8951),U=s(1693),N=s(7410),z=s(2669),K=s(8582),O=s.n(K);const I=(0,R.A)(A,[["render",k]]),j=I;O()(A,"components",{QPage:q.A,QSpinner:C.A,QInput:S.A,QIcon:W.A,QSelect:F.A,QList:T.A,QCard:L.A,QCarousel:Q.A,QCarouselSlide:X.A,QBtn:U.A,QTooltip:N.A,QCardActions:z.A})}}]);